<!-- ๐จ Student Photo Upload & Background Removal Interface -->
<div id="photo-upload-section" class="bg-white rounded-2xl shadow-lg p-6">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ุตูุฑุชู ุงูุดุฎุตูุฉ</h2>
        <p class="text-gray-600">ุงุฑูุน ุตูุฑุชู ูุชุธูุฑ ูู ุงูุจุทุงูุฉ ูุงูุดูุงุฏุฉ. ูููุถู ุฎูููุฉ ุจูุถุงุก</p>
    </div>

    <!-- Current Photo Display -->
    <div class="mb-6">
        <div id="current-photo-container" class="flex justify-center">
            <div id="photo-preview" class="relative">
                <img id="preview-image" src="" alt="ุตูุฑุชู" 
                     class="w-48 h-64 object-cover rounded-lg border-4 border-gray-200 hidden">
                <div id="no-photo-placeholder" 
                     class="w-48 h-64 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-lg border-4 border-dashed border-gray-300 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <p class="text-gray-500 text-sm">ูุง ุชูุฌุฏ ุตูุฑุฉ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="space-y-4">
        <!-- File Input -->
        <div class="relative">
            <input type="file" id="photo-input" accept="image/jpeg,image/jpg,image/png" 
                   class="hidden">
            <label for="photo-input" 
                   class="block w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl cursor-pointer hover:from-blue-700 hover:to-indigo-700 transition-all text-center font-semibold shadow-lg hover:shadow-xl">
                <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                ุงุฎุชุฑ ุตูุฑุฉ ุฌุฏูุฏุฉ
            </label>
        </div>

        <!-- Background Removal Option -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl border-2 border-purple-200">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="remove-bg-checkbox" checked 
                       class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                <div class="mr-3 flex-1">
                    <span class="text-gray-800 font-semibold">ุฅุฒุงูุฉ ุงูุฎูููุฉ ุชููุงุฆููุง</span>
                    <p class="text-sm text-gray-600 mt-1">
                        ุณูููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุฅุฒุงูุฉ ุงูุฎูููุฉ ูุชุญููููุง ุฅูู ุจูุถุงุก ูููุฉ
                    </p>
                </div>
                <div class="bg-purple-100 p-2 rounded-lg">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
            </label>
        </div>

        <!-- Requirements Notice -->
        <div class="bg-blue-50 border-r-4 border-blue-600 p-4 rounded-lg">
            <h3 class="text-blue-900 font-semibold mb-2 flex items-center">
                <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                ูุชุทูุจุงุช ุงูุตูุฑุฉ
            </h3>
            <ul class="text-sm text-blue-800 space-y-1 mr-7">
                <li>โข ุงูุญุฏ ุงูุฃุฏูู: 300ร400 ุจูุณู (ูููุถู ุฏูุฉ ุฃุนูู)</li>
                <li>โข ุงูุตูุบุฉ: JPG ุฃู PNG</li>
                <li>โข ุฎูููุฉ ูุงุถุญุฉ (ูููุถู ุงูุจูุถุงุก ุฃู ุงูููุญุฏุฉ)</li>
                <li>โข ุตูุฑุฉ ูุงุถุญุฉ ูููุฌู ุจุฒุงููุฉ ูุจุงุดุฑุฉ</li>
            </ul>
        </div>

        <!-- Upload Button -->
        <button id="upload-btn" 
                class="w-full px-6 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed hidden">
            <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            ุฑูุน ุงูุตูุฑุฉ ุงูุขู
        </button>

        <!-- Remove Background from Existing Photo -->
        <button id="process-existing-btn" 
                class="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl hidden">
            <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
            ูุนุงูุฌุฉ ุงูุตูุฑุฉ ุงูุญุงููุฉ ูุฅุฒุงูุฉ ุงูุฎูููุฉ
        </button>
    </div>

    <!-- Progress Indicator -->
    <div id="upload-progress" class="hidden mt-6">
        <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-xl p-6">
            <div class="flex items-center justify-between mb-3">
                <span class="text-gray-700 font-semibold">ุฌุงุฑู ุงููุนุงูุฌุฉ...</span>
                <span id="progress-percentage" class="text-indigo-600 font-bold">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="progress-bar" 
                     class="bg-gradient-to-r from-blue-600 to-indigo-600 h-3 rounded-full transition-all duration-500" 
                     style="width: 0%"></div>
            </div>
            <p id="progress-message" class="text-sm text-gray-600 mt-2 text-center">
                ูุฑุฌู ุงูุงูุชุธุงุฑ...
            </p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="photo-message" class="hidden mt-4"></div>
</div>

<script>
// ๐จ Photo Upload & Background Removal Handler
(function() {
    const photoInput = document.getElementById('photo-input');
    const uploadBtn = document.getElementById('upload-btn');
    const processExistingBtn = document.getElementById('process-existing-btn');
    const removeBgCheckbox = document.getElementById('remove-bg-checkbox');
    const previewImage = document.getElementById('preview-image');
    const noPhotoPlaceholder = document.getElementById('no-photo-placeholder');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    const photoMessage = document.getElementById('photo-message');

    let selectedFile = null;
    let currentPhotoPath = null;

    // Load current photo
    async function loadCurrentPhoto() {
        try {
            const response = await fetch('../api/photo_background_remover.php?action=get_photo');
            const data = await response.json();

            if (data.success && data.has_photo) {
                previewImage.src = data.photo_url;
                previewImage.classList.remove('hidden');
                noPhotoPlaceholder.classList.add('hidden');
                processExistingBtn.classList.remove('hidden');
                currentPhotoPath = data.photo_url.replace('../../', '');
            }
        } catch (error) {
            console.error('Error loading photo:', error);
        }
    }

    // Handle file selection
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.match('image/(jpeg|jpg|png)')) {
            showMessage('ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุจุตูุบุฉ JPG ุฃู PNG', 'error');
            return;
        }

        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showMessage('ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏูุง. ุงูุญุฏ ุงูุฃูุตู 10 ููุฌุงุจุงูุช', 'error');
            return;
        }

        selectedFile = file;

        // Preview image
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.classList.remove('hidden');
            noPhotoPlaceholder.classList.add('hidden');
            uploadBtn.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    });

    // Upload photo
    uploadBtn.addEventListener('click', async function() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('photo', selectedFile);
        formData.append('action', 'upload_and_process');
        formData.append('remove_background', removeBgCheckbox.checked ? 'true' : 'false');

        uploadBtn.disabled = true;
        uploadProgress.classList.remove('hidden');
        photoMessage.classList.add('hidden');

        try {
            // Simulate progress for better UX
            simulateProgress();

            const response = await fetch('../api/photo_background_remover.php', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            uploadProgress.classList.add('hidden');
            uploadBtn.disabled = false;

            if (data.success) {
                showMessage(data.message, 'success');
                
                // Update preview with new photo
                previewImage.src = data.photo_url + '?' + Date.now(); // Cache bust
                
                processExistingBtn.classList.remove('hidden');
                uploadBtn.classList.add('hidden');
                
                // Show processing method
                if (data.method) {
                    const methodNames = {
                        'removebg_api': 'Remove.bg API (ุฃุนูู ุฌูุฏุฉ)',
                        'cloudinary_ai': 'Cloudinary AI',
                        'imagick_advanced': 'ูุนุงูุฌุฉ ูุญููุฉ ูุชูุฏูุฉ (Imagick)',
                        'gd_advanced': 'ูุนุงูุฌุฉ ูุญููุฉ (GD)',
                        'original': 'ุงูุตูุฑุฉ ุงูุฃุตููุฉ'
                    };
                    console.log('Processing method:', methodNames[data.method] || data.method);
                }
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            uploadProgress.classList.add('hidden');
            uploadBtn.disabled = false;
            showMessage('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุน ุงูุตูุฑุฉ', 'error');
            console.error(error);
        }
    });

    // Process existing photo
    processExistingBtn.addEventListener('click', async function() {
        if (!currentPhotoPath) return;

        if (!confirm('ูู ุชุฑูุฏ ุฅุฒุงูุฉ ุงูุฎูููุฉ ูู ุงูุตูุฑุฉ ุงูุญุงููุฉุ\nุณูุชู ุงุณุชุจุฏุงููุง ุจูุณุฎุฉ ุจุฎูููุฉ ุจูุถุงุก ูููุฉ.')) {
            return;
        }

        const formData = new FormData();
        formData.append('action', 'remove_background_existing');
        formData.append('photo_path', currentPhotoPath);

        processExistingBtn.disabled = true;
        uploadProgress.classList.remove('hidden');
        photoMessage.classList.add('hidden');

        try {
            simulateProgress();

            const response = await fetch('../api/photo_background_remover.php', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            uploadProgress.classList.add('hidden');
            processExistingBtn.disabled = false;

            if (data.success) {
                showMessage(data.message, 'success');
                previewImage.src = data.photo_url + '?' + Date.now(); // Cache bust
                currentPhotoPath = data.photo_url.replace('../../', '');
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            uploadProgress.classList.add('hidden');
            processExistingBtn.disabled = false;
            showMessage('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุตูุฑุฉ', 'error');
            console.error(error);
        }
    });

    // Simulate progress for better UX
    function simulateProgress() {
        let progress = 0;
        const messages = [
            'ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ...',
            'ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ...',
            'ุฌุงุฑู ุงูุชุดุงู ุงูุฎูููุฉ...',
            'ุฌุงุฑู ุฅุฒุงูุฉ ุงูุฎูููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู...',
            'ุฌุงุฑู ุชุญุณูู ุงูุตูุฑุฉ...',
            'ุฌุงุฑู ุงูุญูุธ...'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = Math.round(progress) + '%';
            
            const messageIndex = Math.min(Math.floor(progress / 15), messages.length - 1);
            progressMessage.textContent = messages[messageIndex];
        }, 300);

        // Clear interval after 10 seconds
        setTimeout(() => clearInterval(interval), 10000);
    }

    // Show message
    function showMessage(message, type) {
        photoMessage.className = 'mt-4 p-4 rounded-xl ' + 
            (type === 'success' 
                ? 'bg-green-50 border-r-4 border-green-600 text-green-800' 
                : 'bg-red-50 border-r-4 border-red-600 text-red-800');
        photoMessage.textContent = message;
        photoMessage.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            photoMessage.classList.add('hidden');
        }, 5000);
    }

    // Initialize
    loadCurrentPhoto();
})();
</script>

<style>
#photo-upload-section {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#preview-image {
    transition: all 0.3s ease;
}

#preview-image:hover {
    transform: scale(1.05);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

#progress-bar {
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -1000px 0;
    }
    100% {
        background-position: 1000px 0;
    }
}
</style>
