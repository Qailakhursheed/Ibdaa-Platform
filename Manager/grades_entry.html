<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª - Ø¥Ø¨Ø¯Ø§Ø¹ ØªØ¹Ø²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-6">
        <!-- Header -->
        <div class="max-w-7xl mx-auto mb-8">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 text-white">
                <h1 class="text-4xl font-bold mb-2">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h1>
                <p class="text-indigo-100">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ</p>
            </div>
        </div>

        <div class="max-w-7xl mx-auto">
            <!-- Course Selection -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø©</h2>
                <select id="course-select" title="Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø©" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-indigo-500 focus:outline-none">
                    <option value="">-- Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø© --</option>
                </select>
            </div>

            <!-- Students List -->
            <div id="students-container" class="hidden">
                <!-- Grade Components Configuration -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
                    <div id="components-container" class="space-y-3">
                        <!-- Will be filled dynamically -->
                    </div>
                    <button onclick="addComponent()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ÙƒÙˆÙ†
                    </button>
                </div>

                <!-- Students Grades Table -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
                        <button onclick="saveAllGrades()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-bold shadow-lg">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full" id="grades-table">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-right font-bold text-gray-700">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    <!-- Component columns will be added dynamically -->
                                    <th class="p-3 text-center font-bold text-gray-700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                    <th class="p-3 text-center font-bold text-gray-700">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="grades-tbody">
                                <!-- Will be filled dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="generateCertificatesForPassed()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-bold">
                            <i class="fas fa-award ml-2"></i>Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù„Ù†Ø§Ø¬Ø­ÙŠÙ†
                        </button>
                        <button onclick="exportToExcel()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-bold">
                            <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                        </button>
                        <button onclick="sendNotificationsToAll()" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition font-bold">
                            <i class="fas fa-bell ml-2"></i>Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden bg-white rounded-xl shadow-lg p-12 text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-semibold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="success-toast" class="hidden fixed top-4 left-4 right-4 bg-green-600 text-white p-4 rounded-xl shadow-2xl z-50 animate-slide-down">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <div class="flex-1">
                <h4 class="font-bold">Ù†Ø¬Ø­Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!</h4>
                <p id="toast-message" class="text-sm text-green-100"></p>
            </div>
        </div>
    </div>

    <script>
        let currentCourse = null;
        let components = [
            { name: 'Ø§Ù„Ø­Ø¶ÙˆØ±', max: 10, weight: 0.1 },
            { name: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', max: 10, weight: 0.1 },
            { name: 'Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª', max: 20, weight: 0.2 },
            { name: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†ØµÙÙŠ', max: 20, weight: 0.2 },
            { name: 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', max: 40, weight: 0.4 }
        ];
        let students = [];
        let grades = {};

        // Load courses
        async function loadCourses() {
            try {
                const response = await fetch('api/get_courses.php');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('course-select');
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Course selection handler
        document.getElementById('course-select').addEventListener('change', async function() {
            const courseId = this.value;
            
            if (!courseId) {
                document.getElementById('students-container').classList.add('hidden');
                return;
            }

            currentCourse = courseId;
            await loadStudents(courseId);
            renderComponents();
            renderStudents();
            document.getElementById('students-container').classList.remove('hidden');
        });

        // Load students enrolled in course
        async function loadStudents(courseId) {
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch(`api/get_enrolled_students.php?course_id=${courseId}`);
                const data = await response.json();
                
                if (data.success) {
                    students = data.students;
                    
                    // Load existing grades
                    const gradesResponse = await fetch(`api/grades_system.php?action=get_all_grades&course_id=${courseId}`);
                    const gradesData = await gradesResponse.json();
                    
                    if (gradesData.success) {
                        grades = {};
                        gradesData.grades.forEach(student => {
                            grades[student.student_id] = {};
                            student.components.forEach(comp => {
                                grades[student.student_id][comp.component] = {
                                    value: comp.value,
                                    max: comp.max
                                };
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading students:', error);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Render components
        function renderComponents() {
            const container = document.getElementById('components-container');
            container.innerHTML = '';
            
            components.forEach((comp, index) => {
                const div = document.createElement('div');
                div.className = 'flex gap-3 items-center bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <input type="text" value="${comp.name}" 
                           onchange="updateComponent(${index}, 'name', this.value)"
                           class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒÙˆÙ†">
                    <input type="number" value="${comp.max}" 
                           onchange="updateComponent(${index}, 'max', this.value)"
                           class="w-24 border border-gray-300 rounded px-3 py-2" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰">
                    <input type="number" step="0.1" value="${comp.weight}" 
                           onchange="updateComponent(${index}, 'weight', this.value)"
                           class="w-24 border border-gray-300 rounded px-3 py-2" placeholder="Ø§Ù„ÙˆØ²Ù†">
                    <button onclick="removeComponent(${index})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function updateComponent(index, field, value) {
            components[index][field] = field === 'weight' || field === 'max' ? parseFloat(value) : value;
            renderStudents();
        }

        function addComponent() {
            components.push({ name: 'Ù…ÙƒÙˆÙ† Ø¬Ø¯ÙŠØ¯', max: 10, weight: 0.1 });
            renderComponents();
            renderStudents();
        }

        function removeComponent(index) {
            if (components.length <= 1) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…ÙƒÙˆÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            components.splice(index, 1);
            renderComponents();
            renderStudents();
        }

        // Render students table
        function renderStudents() {
            const thead = document.querySelector('#grades-table thead tr');
            const tbody = document.getElementById('grades-tbody');
            
            // Update header
            thead.innerHTML = '<th class="p-3 text-right font-bold text-gray-700">Ø§Ù„Ø·Ø§Ù„Ø¨</th>';
            components.forEach(comp => {
                thead.innerHTML += `<th class="p-3 text-center font-bold text-gray-700">${comp.name}<br><span class="text-xs text-gray-500">(${comp.max})</span></th>`;
            });
            thead.innerHTML += `
                <th class="p-3 text-center font-bold text-gray-700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                <th class="p-3 text-center font-bold text-gray-700">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            `;
            
            // Render rows
            tbody.innerHTML = '';
            students.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                let html = `<td class="p-3">
                    <div class="font-semibold text-gray-800">${student.full_name}</div>
                    <div class="text-sm text-gray-500">${student.username}</div>
                </td>`;
                
                let total = 0;
                components.forEach(comp => {
                    const existing = grades[student.id]?.[comp.name];
                    const value = existing?.value || 0;
                    
                    html += `<td class="p-3 text-center">
                        <input type="number" 
                               min="0" 
                               max="${comp.max}" 
                               value="${value}"
                               onchange="updateGrade(${student.id}, '${comp.name}', this.value, ${comp.max})"
                               class="w-20 border-2 border-gray-300 rounded-lg px-2 py-1 text-center focus:border-indigo-500 focus:outline-none">
                    </td>`;
                    
                    if (value > 0) {
                        total += (value / comp.max) * comp.weight * 100;
                    }
                });
                
                const status = total >= 90 ? 'Ù…Ù…ØªØ§Ø²' : total >= 70 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' : total >= 50 ? 'Ø¬ÙŠØ¯' : 'Ø±Ø§Ø³Ø¨';
                const statusColor = total >= 90 ? 'green' : total >= 70 ? 'blue' : total >= 50 ? 'yellow' : 'red';
                
                html += `
                    <td class="p-3 text-center">
                        <span class="text-2xl font-bold ${total >= 50 ? 'text-green-600' : 'text-red-600'}" id="total-${student.id}">
                            ${total.toFixed(1)}%
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <span class="inline-block bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-semibold" id="status-${student.id}">
                            ${status}
                        </span>
                        ${total >= 50 ? '<div class="text-xs text-green-600 mt-1">âœ… Ù…Ø¤Ù‡Ù„ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©</div>' : ''}
                    </td>
                `;
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        function updateGrade(studentId, component, value, max) {
            if (!grades[studentId]) {
                grades[studentId] = {};
            }
            
            grades[studentId][component] = {
                value: parseFloat(value),
                max: max
            };
            
            // Recalculate total
            let total = 0;
            components.forEach(comp => {
                const grade = grades[studentId][comp.name];
                if (grade && grade.value > 0) {
                    total += (grade.value / comp.max) * comp.weight * 100;
                }
            });
            
            // Update UI
            document.getElementById(`total-${studentId}`).textContent = total.toFixed(1) + '%';
            
            const status = total >= 90 ? 'Ù…Ù…ØªØ§Ø²' : total >= 70 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' : total >= 50 ? 'Ø¬ÙŠØ¯' : 'Ø±Ø§Ø³Ø¨';
            const statusColor = total >= 90 ? 'green' : total >= 70 ? 'blue' : total >= 50 ? 'yellow' : 'red';
            const statusEl = document.getElementById(`status-${studentId}`);
            statusEl.textContent = status;
            statusEl.className = `inline-block bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-semibold`;
        }

        // Save all grades
        async function saveAllGrades() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            
            try {
                const promises = [];
                
                for (const [studentId, studentGrades] of Object.entries(grades)) {
                    const gradeComponents = [];
                    
                    components.forEach(comp => {
                        const grade = studentGrades[comp.name];
                        if (grade && grade.value >= 0) {
                            gradeComponents.push({
                                component: comp.name,
                                value: grade.value,
                                max: comp.max,
                                weight: comp.weight
                            });
                        }
                    });
                    
                    if (gradeComponents.length > 0) {
                        promises.push(
                            fetch('api/grades_system.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'update_grades',
                                    student_id: studentId,
                                    course_id: currentCourse,
                                    grades: gradeComponents
                                })
                            })
                        );
                    }
                }
                
                await Promise.all(promises);
                showToast('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰');
                
            } catch (error) {
                console.error('Error saving grades:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª';
            }
        }

        // Generate certificates for passed students
        async function generateCertificatesForPassed() {
            const passed = students.filter(student => {
                let total = 0;
                components.forEach(comp => {
                    const grade = grades[student.id]?.[comp.name];
                    if (grade && grade.value > 0) {
                        total += (grade.value / comp.max) * comp.weight * 100;
                    }
                });
                return total >= 50;
            });
            
            if (passed.length === 0) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø§Ø¬Ø­ÙˆÙ† Ø¨Ø¹Ø¯');
                return;
            }
            
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù€ ${passed.length} Ø·Ø§Ù„Ø¨ Ù†Ø§Ø¬Ø­ØŸ`)) {
                showToast(`Ø¬Ø§Ø±ÙŠ Ø¥ØµØ¯Ø§Ø± ${passed.length} Ø´Ù‡Ø§Ø¯Ø©...`);
                // Implementation here - call certificate generation API
            }
        }

        // Export to Excel
        function exportToExcel() {
            let csv = 'Ø§Ù„Ø·Ø§Ù„Ø¨,';
            csv += components.map(c => c.name).join(',') + ',Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ,Ø§Ù„Ø­Ø§Ù„Ø©\n';
            
            students.forEach(student => {
                csv += `${student.full_name},`;
                
                let total = 0;
                components.forEach(comp => {
                    const grade = grades[student.id]?.[comp.name];
                    const value = grade?.value || 0;
                    csv += `${value},`;
                    
                    if (value > 0) {
                        total += (value / comp.max) * comp.weight * 100;
                    }
                });
                
                const status = total >= 90 ? 'Ù…Ù…ØªØ§Ø²' : total >= 70 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' : total >= 50 ? 'Ø¬ÙŠØ¯' : 'Ø±Ø§Ø³Ø¨';
                csv += `${total.toFixed(1)}%,${status}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `grades_${currentCourse}_${Date.now()}.csv`;
            link.click();
            
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }

        // Send notifications
        function sendNotificationsToAll() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¬Ø§ØªÙ‡Ù…ØŸ')) {
                showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨!');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('success-toast');
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        loadCourses();
    </script>

    <style>
        @keyframes slide-down {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-down {
            animation: slide-down 0.3s ease-out;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
    </style>
</body>
</html>
