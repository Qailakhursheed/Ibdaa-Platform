(function(window){
    // Yemen governorates and districts mapping
    const yemen = {
        "أمانة العاصمة": ["الصافية","التحرير","الوحدة","السَّبعين","الثورة","شعوب","معين","بني الحارث","أخرى"],
        "صنعاء": ["بني مطر","سنحان وبني بهلول","بلاد الروس","الحيمة الداخلية","الحيمة الخارجية","خولان","بني حشيش","نهم","همدان","أرحب","أخرى"],
        "تعز": ["التعزية","صالة","المظفر","القاهرة","المواسط","الشمايتين","جبل حبشي","المعافر","المسراخ","صبر الموادم","ماوية","المخا","باب المندب","ذباب","المقبنة","حيفان","الصلو","شرعب الرونة","شرعب السلام","مشرعة وحدنان","سامع","الوازعية","أخرى"],
        "عدن": ["المنصورة","البريقة","الشيخ عثمان","خور مكسر","صيرة (كريتر)","دار سعد","التواهي","المعلا","أخرى"],
        "إب": ["الظهار","المشنة","ريف إب","بعدان","السياني","حزم العدين","العدين","النادرة","يريم","السدة","الشعر","المخادر","جبلة","فرع العدين","القفر","أخرى"],
        "ذمار": ["ذمار","عنس","الحداء","ميفعة عنس","جهران","وصاب العالي","وصاب السافل","الوده","أخرى"],
        "الحديدة": ["الحديدة","الحالي","الميناء","بيت الفقيه","المنصورية","باجل","زبيد","الضحي","اللحية","القناوص","الزهرة","المنيرة","السخنة","حيس","الجراحي","التحيتا","الدريهمي","بُرَع","الحُجَيلة","أخرى"],
        "البيضاء": ["البيضاء","السواديّة","الزاهر","الصومعة","الملاجم","ناطع","نعمان","رداع","القريشية","ولد ربيع","مسورة","الشرِيّة","ذي ناعم","الرياشية","أخرى"],
        "ريمة": ["الجبين","كسمة","السلفية","مزهر","بلاد الطعام","الجَعفرية","أخرى"],
        "الضالع": ["الضالع","قعطبة","جبن","دمت","الحشا","الأزارق","الحُصين","الشعيب","جُحاف","أخرى"],
        "لحج": ["تبن","الحوطة","المَسيمير","القبيطة","المَضاربة ورأس العارة","طور الباحة","يَافع","كرب","أخرى"],
        "أبين": ["زنجبار","خنفر","لودر","مَودية","المحفد","أحور","جيشان","سرار","رصد","سباح","أخرى"],
        "شبوة": ["عتق","بيحان","عسيلان","عين","نصاب","حَطيب","الصعيد","ميفعة","جردان","حَبّان","رَضوم","مرخة السفلى","مرخة العليا","أخرى"],
        "حضرموت": ["المكلا","الشحر","غيل باوزير","الديس الشرقية","بروم ميفع","حجر","سيئون","تريم","شبام","ساه","وادي العين وحورة","قطن","العبر","رخية","أخرى"],
        "المهرة": ["الغيضة","سيحوت","حوف","المسيلة","قشن","حصوين","حَساي","منعر","حَات","أخرى"],
        "مأرب": ["مدينة مأرب","الوادي","الجوبة","صرواح","مدغل","رغوان","رحبة","حريب","حريب القراميش","أخرى"],
        "الجوف": ["الغيل","الزاهر","الخلق","برط العنان","خب والشعف","الحزم","المتون","رجوزة","خَبّ","أخرى"],
        "حجة": ["حجة","المحابشة","أفلح الشام","أفلح اليمن","المغربة","الشاهل","الجميمة","كُشر","قارة","وشحة","بني قيس","بني العوام","ميدي","عبس","حرض","مستباء","كعيدنة","أسلم","القفل","بكيل المير","الشغادرة","أخرى"],
        "صعدة": ["صعدة","سحار","ساقين","رازح","غمر","شدا","منبه","كتاف والبقع","باقِم","الصفراء","الحشوة","مجز","حيدان","أخرى"],
        "عمران": ["عمران","ريدة","السودة","العشة","مديرية عيال سريح","مسور","خمر","قفلة عذر","حوث","أخرى"],
        "سقطرى": ["حديبو","قلنسية وعبدالكوري","أخرى"]
    };

    function fillGovernoratesByElement(govEl){
        govEl.innerHTML = '<option value="">اختر المحافظة</option>';
        Object.keys(yemen).forEach(gov => {
            const opt = document.createElement('option');
            opt.value = gov;
            opt.textContent = gov;
            govEl.appendChild(opt);
        });
    }

    function fillDistrictsByElement(gov, distEl, otherEl){
        distEl.innerHTML = '<option value="">اختر المديرية</option>';
        const list = yemen[gov] || [];
        list.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            distEl.appendChild(opt);
        });
        if (otherEl) { otherEl.style.display = 'none'; otherEl.required = false; otherEl.value = ''; }
    }

    // Public API
    const YemenLocations = {
        init: function(govId, distId, otherId){
            const govEl = document.getElementById(govId);
            const distEl = document.getElementById(distId);
            const otherEl = otherId ? document.getElementById(otherId) : null;
            if (!govEl || !distEl) return;

            fillGovernoratesByElement(govEl);

            govEl.addEventListener('change', function(e){
                fillDistrictsByElement(e.target.value, distEl, otherEl);
            });

            distEl.addEventListener('change', function(e){
                if (!otherEl) return;
                if (e.target.value === 'أخرى') { otherEl.style.display = 'block'; otherEl.required = true; }
                else { otherEl.style.display = 'none'; otherEl.required = false; otherEl.value = ''; }
            });

            // If the selects are already filled (e.g., for edit forms), trigger district fill
            if (govEl.value) fillDistrictsByElement(govEl.value, distEl, otherEl);
        },
        // helper for manual population
        populate: fillGovernoratesByElement,
        mapping: yemen
    };

    window.YemenLocations = YemenLocations;
})(window);
